<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/compression"></script>
    <style>
        html,
        body {
            padding: 10px;
            background: black;
            font-family: Arial, Helvetica, sans-serif;
            color: white;
        }

        #search {
            padding: 2px;
        }

        #results {
            padding: 6px;
        }

        #player {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: transparent;
        }

        #playerContent {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background: black;
        }

        #progress {
            background-color: rgba(255, 255, 255, 0.15);
            width: calc(100% - 100px);
            height: 8px;
            position: absolute;
            bottom: 50px;
            /* left: 200px; */
            border-radius: 4px;
            cursor: pointer;
        }

        #progress-tracker {
            background-color: royalblue;
            border-radius: 4px;
            width: 0.6%;
            height: 100%;
            transition: .3s;
        }

        #dragger {
            width: 12px;
            height: 12px;
            background-color: white;
            position: absolute;
            top: 0;
            bottom: 0;
            margin: auto;
            left: 0%;
            border-radius: 50%;
            transition: .3s;
            cursor: pointer;
        }

        #song-time {
            position: absolute;
            right: 55px;
        }

        #album-art {
            width: 200px;
            height: 200px;
            border-radius: 10px;
            position: absolute;
            top: -220px;
            transition: .3s;
            opacity: 0;
        }

        #song-name {
            display: flex;
            align-items: center;
        }

        #like-song-button {
            cursor: pointer;
        }

        #create-playlist-screen {
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            background: black;
            margin-left: 28px;
            display: none;
        }

        #playlist-modal {
            width: calc(60% - 25px);
            height: 70%;
            position: fixed;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            margin: auto;
            background: #121212;
            border-radius: 12px;
            padding: 0px;
            padding-left: 25px;
            display: none;
            user-select: none;
        }

        #PM-ADD-SONG-TO-PLAYLIST-INPUT {
            display: none;
        }

        #PM-SONGS {
            height: 100%;
            overflow: auto;
            margin-top: 10px;
        }

        #PM-RESULTS {
            position: absolute;
            background-color: #222222;
            margin-top: 10px;
            padding: 6px;
            padding-right: 16px;
            border-radius: 10px;
            z-index: 99999;
            display: none;
        }

        #PM-ADD-SONG-CLICK-COVER {
            position: absolute;
            top: 0;
            left: 0;
            backdrop-filter: blur(1.5px);
            background: rgba(0, 0, 0, 0.5);
            width: 100%;
            height: 100%;
            display: none;
        }

        #PM-SEARCH {
            position: relative;
            z-index: 99999;
        }

        #PM-NAME {
            position: relative;
            z-index: 99999;
        }

        #PM-CONTENT-COVER {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            backdrop-filter: blur(1.5px);
            background: rgba(0, 0, 0, 0.5);
        }

        .PLAYLIST-REMOVE-LISTITEM:hover {
            opacity: 1 !important;
        }

        .progress-controls {
            margin-left: 50px;
        }

        .playlist-data-holder:hover {
            background: rgba(255, 255, 255, 0.06) !important;
        }

        .PLAYLIST-LCONC-LISTITEM:hover {
            background-color: rgba(255, 255, 255, 0.06) !important;
        }
    </style>
    <title>Vinga Music Stream</title>
</head>
<body>
    <div id="playerContent">
        <audio id="player" style="display: none;">
            <source id="s1" type="audio/mpeg">
            Your browser does not support audio playback.
        </audio>
        <div class="progress-controls">
            <img id="album-art">
            <span id="song-name"></span>
            <span id="song-time"></span>
            <div id="progress">
                <div id="progress-tracker"></div>
                <div id="dragger"></div>
            </div>
        </div>
    </div>
    <input id="search">
    <div id="results"></div>
    <button id="create-playlist-button">Create Playlist</button>
    <button id="export-data-button">Export User Data</button><br><br>
    <div id="playlists"></div>
    <img id="art">
    <span id="name"></span>
    <div id="create-playlist-screen">
        <h1>Create a new playlist</h1>
        <input id="CPS-NAME" placeholder="Playlist name" type="text"><br><br>
        <button id="save-playlist-button">Create Playlist</button>
    </div>
    <div id="PM-CONTENT-COVER"></div>
    <div id="playlist-modal">
        <h1 id="PM-NAME">PLAYLIST NAME</h1>
        <button id="PM-ADD-SONG-BUTTON">Add Song</button>
        <div id="PM-ADD-SONG-TO-PLAYLIST-INPUT">
            <input id="PM-SEARCH">
            <div id="PM-RESULTS"></div>
        </div>
        <div id="PM-SONGS"></div>
        <div id="PM-ADD-SONG-CLICK-COVER"></div>
    </div>

    <script>
        var noProgressUpdate = false;
        var likeButtonDisabled = true;
        var likes = [];
        var playlists = [];
        function getSelectedPlaylist() {
            try { return JSON.parse(document.getElementById("playlist-modal").getAttribute("PLAYLISTDATA")); } catch { return {} }
        }
        function removeSongFromPlaylistWithID(id, songId) {
            for (let i = 0; i < playlists.length; i++) {
                if (playlists[i].id === id) {
                    for (let ii = 0; ii < playlists[i].songs.length; ii++) {
                        if (playlists[i].songs[ii] === songId) {
                            playlists[i].songs.splice(ii, 1);
                            break;
                        }
                    }
                }
            }
            savePlaylists()
        }
        function openPlaylistScreen(id) {
            var pl = null;
            for (let i = 0; i < playlists.length; i++) {
                if (playlists[i].id === id) {
                    pl = playlists[i];
                    break;
                }
            }
            if (pl === null) return;

            document.getElementById("PM-NAME").innerText = pl.name;

            function finishLoad() {
                document.getElementById("playlist-modal").style.display = "block";
                document.getElementById("playlist-modal").setAttribute("PLAYLISTDATA", JSON.stringify(pl));
                const listOffset = document.getElementById("PM-SONGS").getBoundingClientRect().y - document.getElementById("playlist-modal").getBoundingClientRect().y;
                document.getElementById("PM-SONGS").style.height = "calc(100% - " + listOffset + "px)";
                document.getElementById("PM-CONTENT-COVER").style.display = "block";
            }

            fetch("/getsongs", {
                method: "POST",
                headers: {
                    'content-type': 'application/json'
                },
                body: JSON.stringify({
                    songs: pl.songs
                })
            })
            .then(r => r.json())
            .then(r => {
                const resultsEl = document.getElementById("PM-SONGS");
                resultsEl.innerHTML = "";
                var container = document.createElement("div");
                container.style.marginTop = "-10px";
                for (let i = 0; i < r.length; i++) {
                    r[i].pointer = i;
                }
                for (let i = 0; i < r.length; i++) {
                    const el = r[i];
                    var lconC = document.createElement("div");
                    lconC.style.width = "calc(100% - 20px)";
                    lconC.style.height = "70px";
                    lconC.style.background = "rgba(255, 255, 255, 0.04)";
                    lconC.style.borderRadius = "8px";
                    lconC.style.display = "flex";
                    lconC.style.alignItems = "center";
                    lconC.style.marginTop = "10px";
                    lconC.className = "PLAYLIST-LCONC-LISTITEM";
                    var lcon = document.createElement("div");
                    lcon.style.display = "flex";
                    lcon.style.alignItems = "center";
                    lcon.style.padding = "5px";
                    lcon.style.width = "100%";
                    lcon.style.cursor = "pointer";
                    lcon.onclick = () => {
                        playSongFromObjWithQueue(el.pointer, r);
                    }
                    var img = document.createElement("img");
                    img.src = "/art/"+el.art
                    img.style.width = "52px";
                    img.style.height = "52px";
                    img.style.marginLeft = "4px";
                    img.style.borderRadius = "6px";
                    var name = document.createElement("span");
                    name.innerText = el.name
                    name.style.paddingLeft = "10px";
                    var removeIcon = document.createElement("span");
                    removeIcon.innerHTML = `<?xml version="1.0" encoding="iso-8859-1"?><!-- Generator: Adobe Illustrator 19.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0) --><svg width="20px" height="20px" style="filter: invert();" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"><g><g><path d="M465.423,48.241h-137.61V23.955C327.813,10.746,317.082,0,303.893,0h-95.785c-13.19,0-23.92,10.746-23.92,23.955V48.24H46.577c-6.655,0-12.049,5.394-12.049,12.049c0,6.655,5.394,12.049,12.049,12.049h22.332l15.228,396.396C85.069,492.995,104.818,512,129.099,512h253.804c24.281,0,44.03-19.006,44.96-43.267l15.228-396.396h22.332c6.653,0,12.049-5.394,12.049-12.049C477.472,53.635,472.078,48.241,465.423,48.241z M208.285,24.097h95.43v24.143h-95.43V24.097z M403.784,467.809c-0.433,11.268-9.605,20.094-20.882,20.094H129.099c-11.276,0-20.448-8.827-20.882-20.095L93.025,72.338h325.952L403.784,467.809z"/></g></g><g><g><path d="M182.63,181.571c-0.127-6.575-5.494-11.817-12.042-11.817c-0.078,0-0.158,0-0.236,0.002c-6.652,0.128-11.943,5.626-11.815,12.278l3.781,196.634c0.126,6.575,5.495,11.817,12.042,11.817c0.078,0,0.158,0,0.236-0.002c6.653-0.128,11.943-5.624,11.815-12.278L182.63,181.571z"/></g></g><g><g><path d="M255.998,169.753c-6.654,0-12.049,5.394-12.049,12.049v196.634c0,6.654,5.394,12.049,12.049,12.049c6.655,0,12.049-5.394,12.049-12.049V181.802C268.047,175.148,262.653,169.753,255.998,169.753z"/></g></g><g><g><path d="M341.645,169.756c-6.628-0.147-12.151,5.162-12.278,11.815l-3.781,196.634c-0.129,6.653,5.162,12.15,11.815,12.278c0.078,0.001,0.158,0.002,0.236,0.002c6.546,0,11.916-5.244,12.042-11.817l3.781-196.634C353.588,175.38,348.299,169.883,341.645,169.756z"/></g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g></svg>`;
                    removeIcon.style.fontSize = "20px";
                    removeIcon.style.textAlign = "right";
                    removeIcon.style.right = "36px";
                    removeIcon.style.zIndex = "999";
                    removeIcon.style.cursor = "pointer";
                    removeIcon.style.opacity = ".25";
                    removeIcon.style.position = "absolute";
                    removeIcon.style.transition = ".2s";
                    removeIcon.className = "PLAYLIST-REMOVE-LISTITEM";
                    removeIcon.onclick = () => {
                        removeSongFromPlaylistWithID(pl.id, el.id);
                        openPlaylistScreen(pl.id);
                    }
                    lcon.appendChild(img);
                    lcon.appendChild(name);
                    lconC.appendChild(lcon);
                    lconC.appendChild(removeIcon);
                    container.appendChild(lconC);
                }
                resultsEl.appendChild(container);
                finishLoad();
            });
        }
        document.getElementById("export-data-button").onclick = () => {
            exportSavedData();
        }
        document.getElementById("PM-CONTENT-COVER").onclick = () => {
            document.getElementById("PM-ADD-SONG-CLICK-COVER").click();
            document.getElementById("PM-CONTENT-COVER").style.display = "none";
            document.getElementById("playlist-modal").style.display = "none";
        }
        document.getElementById("PM-ADD-SONG-CLICK-COVER").onclick = () => {
            document.getElementById("PM-ADD-SONG-CLICK-COVER").style.display = "none";
            document.getElementById("PM-ADD-SONG-TO-PLAYLIST-INPUT").style.display = "none";
            document.getElementById("PM-ADD-SONG-BUTTON").style.display = "block";
        }
        document.getElementById("PM-ADD-SONG-BUTTON").onclick = () => {
            document.getElementById("PM-ADD-SONG-TO-PLAYLIST-INPUT").style.display = "block";
            document.getElementById("PM-ADD-SONG-BUTTON").style.display = "none";
            document.getElementById("PM-ADD-SONG-CLICK-COVER").style.display = "block";
        }
        function downloadToFile(content, filename, contentType) {
            const a = document.createElement('a');
            const file = new Blob([content], {type: contentType});
            
            a.href= URL.createObjectURL(file);
            a.download = filename;
            a.click();

            URL.revokeObjectURL(a.href);
        };
        function refreshPlaylists() {
            var holders = document.createElement("div");

            document.getElementById("playlists").innerHTML = "";

            if (playlists.length === 0) return;

            for (let i = 0; i < playlists.length; i++) {
                const pl = playlists[i];

                var holder = document.createElement("div");
                holder.style.borderRadius = "8px";
                holder.style.background = "rgba(255, 255, 255, 0.04)";
                holder.style.width = "400px";
                holder.style.height = "80px";
                holder.style.cursor = "pointer";
                holder.style.transition = ".15s";
                holder.style.display = "flex";
                holder.style.alignItems = "center";
                holder.style.userSelect = "none";
                holder.className = "playlist-data-holder";
                holder.onclick = () => {
                    openPlaylistScreen(pl.id);
                }
                if (i === 0) {
                    holder.style.marginTop = "0";
                } else {
                    holder.style.marginTop = "10px";
                }

                var image = document.createElement("img");
                image.style.width = "64px";
                image.style.height = "64px";
                image.style.marginLeft = "8px";
                image.style.borderRadius = "6px";
                image.style.marginRight = "20px";
                image.style.border = "none";
                image.src = pl.image === null ? "/cdn/playlist_not_found.png" : pl.image;

                var basicDetailsContainer = document.createElement("div");
                basicDetailsContainer.style.display = "flex"
                basicDetailsContainer.style.justifyContent = "center";
                basicDetailsContainer.style.flexDirection = "column";
                basicDetailsContainer.style.height = "100%";

                var name = document.createElement("span");
                name.innerText = pl.name;
                name.style.fontWeight = "bold";
                name.style.fontSize = "20px";
                name.style.maxWidth = "200px";
                name.style.overflow = "hidden";
                name.style.textOverflow = "ellipsis";
                name.style.whiteSpace = "nowrap";

                var desc = document.createElement("span");
                desc.innerText = pl.description;
                desc.style.fontSize = "15px";
                desc.style.paddingTop = "2.5px";
                desc.style.maxWidth = "280px";
                desc.style.overflow = "hidden";
                desc.style.textOverflow = "ellipsis";
                desc.style.whiteSpace = "nowrap";

                basicDetailsContainer.appendChild(name);
                if (pl.description !== null) basicDetailsContainer.appendChild(desc);

                holder.appendChild(image);
                holder.appendChild(basicDetailsContainer);

                holders.appendChild(holder)
            }

            document.getElementById("playlists").appendChild(holders);
        }
        function loadSavedData() {
            likes = localStorage.getItem("likes") === null ? [] : JSON.parse(LZString.decompress(localStorage.getItem("likes")));
            playlists = localStorage.getItem("playlists") === null ? [] : JSON.parse(LZString.decompress(localStorage.getItem("playlists")));
            
            refreshPlaylists();
        }
        function isCurrentSongLiked() {
            const songId = getSongMeta().id;
            var isLiked = false;
            for (let i = 0; i < likes.length; i++) {
                if (likes[i] === songId) {
                    isLiked = true;
                    break;
                }
            }
            return isLiked;
        }
        function saveData(key, data) {
            localStorage.setItem(key, LZString.compress(data));
        }
        function toggleLikeCurrentSong() {
            if (likeButtonDisabled) return;
            likeButtonDisabled = true;
            const songId = getSongMeta().id;
            var complete = false;
            for (let i = 0; i < likes.length; i++) {
                if (likes[i] === songId) {
                    likes.splice(i, 1);
                    complete = true;
                    break;
                }
            }
            if (!complete) {
                likes.push(songId);
            }
            saveData("likes", JSON.stringify(likes));
            likeButtonDisabled = false;
            refreshSongDataDisplays();
        }
        loadSavedData();
        function savePlaylists() {
            saveData("playlists", JSON.stringify(playlists));
        }
        function createPlaylist(name) {
            var playlistData = {
                name: name,
                description: null,
                image: null,
                createdAt: new Date().getTime(),
                id: Math.round(Math.random() * 9e9),
                songs: []
            }
            playlists.push(playlistData);
            savePlaylists();
            refreshPlaylists();
            document.getElementById("create-playlist-screen").style.display = "none";
        }
        function addSongToPlaylist(id, songId) {
            for (let i = 0; i < playlists.length; i++) {
                if (playlists[i].id === id) {
                    var skip = false;
                    for (let ii = 0; ii < playlists[i].songs.length; ii++) {
                        if (playlists[i].songs[ii] === songId) {
                            skip = true;
                            break;
                        }
                    }
                    if (!skip) {
                        playlists[i].songs.push(songId);
                        savePlaylists();
                    }
                }
            }
        }
        document.getElementById("save-playlist-button").onclick = () => {
            createPlaylist(document.getElementById("CPS-NAME").value);
        }
        document.getElementById("create-playlist-button").onclick = () => {
            document.getElementById("create-playlist-screen").style.display = "block";
        }
        document.getElementById("progress").onclick = (e) => {
            if (!isNaN(document.getElementById("player").duration)) {
                var elmnt = document.getElementById("dragger");
                var track = document.getElementById("progress");
                var handle = document.getElementById("progress-tracker");
                var movement = e.clientX - 50;
                if (movement < 0) {
                    movement = 0;
                } else if (movement > (track.clientWidth - 12)) {
                    movement = track.clientWidth - 12;
                }
                elmnt.style.left = movement + "px";
                handle.style.width = (movement + 6) + "px";
                var newP = (elmnt.style.left.split("px")[0] / (track.clientWidth - 12));
                document.getElementById("player").currentTime = (document.getElementById("player").duration * newP)
            }
        }
        function refreshSongTime() {
            if (!isNaN(document.getElementById("player").duration)) {
                var sec = Math.floor(document.getElementById("player").currentTime);
                var minutes = Math.floor(sec / 60).toString();
                var seconds = (sec - minutes * 60).toString();
                if (minutes.length == 1) {
                    minutes = "0" + minutes
                }
                if (seconds.length == 1) {
                    seconds = "0" + seconds
                }

                var sec1 = Math.floor(document.getElementById("player").duration);
                var minutes1 = Math.floor(sec1 / 60).toString();
                var seconds1 = (sec1 - minutes1 * 60).toString();
                if (minutes1.length == 1) {
                    minutes1 = "0" + minutes1
                }
                if (seconds1.length == 1) {
                    seconds1 = "0" + seconds1
                }

                document.getElementById("song-time").innerText = minutes + ":" + seconds + " / " + minutes1 + ":" + seconds1;
            }
        }
        setInterval(refreshSongTime, 100);
        function refreshSongDataDisplays() {
            var icon = "";
            if (getSongMeta().name !== "" && getSongMeta().name !== "") {
                icon = `<svg style="filter: invert(); margin-right: 10px;" width="22px" height="22px" clip-rule="evenodd" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m12 5.72c-2.624-4.517-10-3.198-10 2.461 0 3.725 4.345 7.727 9.303 12.54.194.189.446.283.697.283s.503-.094.697-.283c4.977-4.831 9.303-8.814 9.303-12.54 0-5.678-7.396-6.944-10-2.461z" fill-rule="nonzero"/></svg>`;
                if (!isCurrentSongLiked()) {
                    icon = `<svg style="filter: invert(); margin-right: 10px;" width="22px" height="22px" clip-rule="evenodd" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m7.234 3.004c-2.652 0-5.234 1.829-5.234 5.177 0 3.725 4.345 7.727 9.303 12.54.194.189.446.283.697.283s.503-.094.697-.283c4.977-4.831 9.303-8.814 9.303-12.54 0-3.353-2.58-5.168-5.229-5.168-1.836 0-3.646.866-4.771 2.554-1.13-1.696-2.935-2.563-4.766-2.563zm0 1.5c1.99.001 3.202 1.353 4.155 2.7.14.198.368.316.611.317.243 0 .471-.117.612-.314.955-1.339 2.19-2.694 4.159-2.694 1.796 0 3.729 1.148 3.729 3.668 0 2.671-2.881 5.673-8.5 11.127-5.454-5.285-8.5-8.389-8.5-11.127 0-1.125.389-2.069 1.124-2.727.673-.604 1.625-.95 2.61-.95z" fill-rule="nonzero"/></svg>`;
                }
            }
            document.getElementById("song-name").innerHTML = `
                <a id="like-song-button" onclick="toggleLikeCurrentSong()">${icon}</a>
                ${getSongMeta().name}
            `
            document.getElementById("album-art").src = "/art/" + getSongMeta().art;
            document.title = getSongMeta().name !== "" && getSongMeta().name !== "" ? getSongMeta().name : "Vinga Music Stream";
            const songNameSections = getSongMeta().name.toString().split(" - ");
            if (songNameSections[0] !== undefined && songNameSections[1] !== undefined) {
                const songArtist = songNameSections[1].includes(" Ft. ") ? songNameSections[0].split(" &").join(",") + ", " + songNameSections[1].split(" Ft. ")[1].split(" &").join(",") : songNameSections[0].split(" &").join(",");
                const songName = songNameSections[1].includes(" Ft. ") ? songNameSections[1].split(" Ft.")[0] : songNameSections[1];
                console.log("Playing", songName, "by", songArtist);
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: songName,
                    artist: songArtist,
                    artwork: [
                        { src: location.protocol+"//"+location.host+"/art/"+getSongMeta().art,   sizes: '300x300',   type: 'image/png' },
                    ]
                });
            }
            refreshSongTime();
        }
        refreshSongDataDisplays();
        function hideAlbumArt() {
            document.getElementById("album-art").style.opacity = 0;
            document.getElementById("album-art").style.top = "-210px";
        }
        function showAlbumArt() {
            document.getElementById("album-art").style.opacity = 1;
            document.getElementById("album-art").style.top = "-220px";
        }
        function dragElement(elmnt, track, handle, setPTime = false) {
            elmnt.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                if (setPTime) {
                    if (isNaN(document.getElementById("player").duration)) {
                        return
                    }
                }
                e = e || window.event;
                e.preventDefault();
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                noProgressUpdate = true;
                elmnt.style.transition = "0s";
                handle.style.transition = "0s";
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                var movement = e.clientX - 50;
                if (movement < 0) {
                    movement = 0;
                } else if (movement > (track.clientWidth - 12)) {
                    movement = track.clientWidth - 12
                }
                elmnt.style.left = movement + "px"
                handle.style.width = (movement + 6) + "px"
            }

            function closeDragElement() {
                try {
                    var newP = (elmnt.style.left.split("px")[0] / (track.clientWidth - 12));

                    if (setPTime) {
                        document.getElementById("player").currentTime = (document.getElementById("player").duration * newP)
                    }
                } catch { }

                document.onmouseup = null;
                document.onmousemove = null;
                noProgressUpdate = false;
                elmnt.style.transition = ".3s";
                handle.style.transition = ".3s";
            }
        }
        dragElement(document.getElementById("dragger"), document.getElementById("progress"), document.getElementById("progress-tracker"), true);
        document.getElementById("player").onplay = () => {
            showAlbumArt();
            function setRandomNextSong() {
                fetch("/random")
                .then(r => r.json())
                .then(r => {
                    nextSongData = r;
                });
            }
            refreshSongDataDisplays();
            likeButtonDisabled = false;
            if (!playerQueue.active) {
                setRandomNextSong();
            } else {
                // console.log(playerQueue.nextPointer, playerQueue.maxPointer);
                if (playerQueue.nextPointer >= playerQueue.maxPointer) {
                    setRandomNextSong();
                    playerQueue.active = false;
                } else {
                    nextSongData = playerQueue.queue[playerQueue.nextPointer];
                    playerQueue.nextPointer = playerQueue.nextPointer+1;
                }
            }
        }
        document.getElementById("player").ontimeupdate = (d) => {
            var percentPlayed = parseFloat(((document.getElementById("player").currentTime / document.getElementById("player").duration) * 100).toFixed(4));
            if (isNaN(percentPlayed)) {
                percentPlayed = 0.6;
            }
            if (percentPlayed > 0 && percentPlayed < 0.6) {
                percentPlayed = 0.6
            }
            if (!noProgressUpdate) {
                document.getElementById("progress-tracker").style.width = percentPlayed + "%"
                document.getElementById("dragger").style.left = (percentPlayed - 0.6) + "%"
            }
        }
        function exportSavedData() {
            loadSavedData();

            const exportData = JSON.stringify({
                likes: likes,
                playlists: playlists
            })
            
            const compressed = LZString.compress(exportData)

            console.log("Exporting locally saved user data (original length:", exportData.length+", compressed:", compressed.length+",", Math.floor((compressed.length / exportData.length)*100)+"% compression)")

            downloadToFile(compressed, "user-export.vmsdata", "text/plain")
        }
        function getSongMeta() {
            try {
                var d = JSON.parse(document.getElementById("player").getAttribute("song-data"));
                if (d === null) {
                    return {
                        name: ""
                    };
                } else {
                    return d;
                }
            } catch {
                return {
                    name: ""
                };
            }
        }
        function setSongMeta(d) {
            document.getElementById("player").setAttribute("song-data", JSON.stringify(d));
        }
        var nextSongData = null;
        document.getElementById("player").onended = () => {
            hideAlbumArt();
            document.getElementById("s1").src = "/audio/"+nextSongData.id;
            document.getElementById("player").load();
            setSongMeta(nextSongData);
            setTimeout(() => {
                document.getElementById("player").play();
            }, 800);
        }
        const refreshSearch = (chkKey, e, resultsEl, clickcb, failcb, successcb) => {
            var v = e.target.value;
            if (chkKey && e.key !== "Enter") {
                v = v + e.key;
            }
            fetch("/search/"+encodeURIComponent(v))
            .then(r => {
                if (r.status === 200) {
                    r.json()
                    .then(r => {
                        resultsEl.innerHTML = "";
                        var container = document.createElement("div");
                        if (failcb && (r.length === 0 || r[0] === null)) failcb();
                        else if (successcb) successcb();
                        r.forEach(el => {
                            var lcon = document.createElement("div");
                            lcon.style.display = "flex";
                            lcon.style.alignItems = "center";
                            lcon.style.padding = "5px";
                            lcon.style.cursor = "pointer";
                            lcon.onclick = () => {
                                clickcb(el);
                            }
                            var img = document.createElement("img");
                            img.src = "/art/"+el.art
                            img.style.width = "60px";
                            img.style.height = "60px";
                            img.style.borderRadius = "6px";
                            var name = document.createElement("span");
                            name.innerText = el.name
                            name.style.paddingLeft = "10px";
                            lcon.appendChild(img);
                            lcon.appendChild(name);
                            container.appendChild(lcon);
                            console.log(el)
                        });
                        resultsEl.appendChild(container);
                    })
                } else {
                    resultsEl.innerHTML = "";
                }
            })
        }
        function playSongFromObj(el) {
            try { document.getElementById("player").pause() } catch { }
            hideAlbumArt();
            setSongMeta(el);
            setTimeout(() => {
                document.getElementById("s1").src = "/audio/"+el.id;
                document.getElementById("player").load();
                document.getElementById("player").play();
            }, 300);
        }
        var playerQueue = {
            active: false,
            nextPointer: 0,
            queue: [],
            maxPointer: 0
        };
        function playSongFromObjWithQueue(pointer, queue) {
            playerQueue.active = true;
            playerQueue.nextPointer = pointer + 1;
            playerQueue.queue = queue;
            playerQueue.maxPointer = queue.length;
            const el = queue[pointer];
            try { document.getElementById("player").pause() } catch { }
            hideAlbumArt();
            setSongMeta(el);
            setTimeout(() => {
                document.getElementById("s1").src = "/audio/"+el.id;
                document.getElementById("player").load();
                document.getElementById("player").play();
            }, 300);
        }
        document.getElementById("search").onkeypress = (e) => {
            refreshSearch(true, e, document.getElementById("results"), playSongFromObj)
        };
        document.getElementById("search").onkeydown = (e) => {
            refreshSearch(false, e, document.getElementById("results"), playSongFromObj)
        };

        document.getElementById("PM-SEARCH").onkeypress = (e) => {
            refreshSearch(true, e, document.getElementById("PM-RESULTS"), (el) => {
                const pl = getSelectedPlaylist();
                if (Object.keys(pl).length === 0) return;
                addSongToPlaylist(pl.id, el.id);
                openPlaylistScreen(pl.id);
                document.getElementById("PM-ADD-SONG-CLICK-COVER").click();
            }, () => {
                document.getElementById("PM-RESULTS").style.display = "none";
            }, () => {
                document.getElementById("PM-RESULTS").style.display = "block";
            })
        };
        document.getElementById("PM-SEARCH").onkeydown = (e) => {
            refreshSearch(false, e, document.getElementById("PM-RESULTS"), (el) => {
                const pl = getSelectedPlaylist();
                if (Object.keys(pl).length === 0) return;
                addSongToPlaylist(pl.id, el.id);
                openPlaylistScreen(pl.id);
                document.getElementById("PM-ADD-SONG-CLICK-COVER").click();
            }, () => {
                document.getElementById("PM-RESULTS").style.display = "none";
            }, () => {
                document.getElementById("PM-RESULTS").style.display = "block";
            })
        };
    </script>
</body>
</html>