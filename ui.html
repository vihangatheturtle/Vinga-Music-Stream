<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        html,
        body {
            padding: 10px;
            background: black;
            font-family: Arial, Helvetica, sans-serif;
            color: white;
        }

        #search {
            padding: 2px;
        }

        #results {
            padding: 6px;
        }

        #player {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: transparent;
        }

        #playerContent {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background: black;
        }

        #progress {
            background-color: rgba(255, 255, 255, 0.15);
            width: calc(100% - 100px);
            height: 8px;
            position: absolute;
            bottom: 50px;
            /* left: 200px; */
            border-radius: 4px;
            cursor: pointer;
        }

        #progress-tracker {
            background-color: royalblue;
            border-radius: 4px;
            width: 0.6%;
            height: 100%;
            transition: .3s;
        }

        #dragger {
            width: 12px;
            height: 12px;
            background-color: white;
            position: absolute;
            top: 0;
            bottom: 0;
            margin: auto;
            left: 0%;
            border-radius: 50%;
            transition: .3s;
            cursor: pointer;
        }

        #song-time {
            position: absolute;
            right: 55px;
        }

        #album-art {
            width: 200px;
            height: 200px;
            border-radius: 10px;
            position: absolute;
            top: -220px;
            transition: .3s;
            opacity: 0;
        }

        #song-name {
            display: flex;
            align-items: center;
        }

        #like-song-button {
            cursor: pointer;
        }

        #create-playlist-screen {
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            background: black;
            margin-left: 28px;
            display: none;
        }

        #playlist-modal {
            width: calc(60% - 25px);
            height: 70%;
            position: fixed;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            margin: auto;
            background: #121212;
            border-radius: 12px;
            padding: 0px;
            padding-left: 25px;
            display: none;
            user-select: none;
        }

        .progress-controls {
            margin-left: 50px;
        }

        .playlist-data-holder:hover {
            background: rgba(255, 255, 255, 0.06) !important;
        }
    </style>
    <title>Vinga Music Stream</title>
</head>
<body>
    <div id="playerContent">
        <audio id="player" style="display: none;">
            <source id="s1" type="audio/mpeg">
            Your browser does not support audio playback.
        </audio>
        <div class="progress-controls">
            <img id="album-art">
            <span id="song-name"></span>
            <span id="song-time"></span>
            <div id="progress">
                <div id="progress-tracker"></div>
                <div id="dragger"></div>
            </div>
        </div>
    </div>
    <input id="search">
    <div id="results"></div>
    <button id="create-playlist-button">Create Playlist</button><br><br>
    <div id="playlists"></div>
    <img id="art">
    <span id="name"></span>
    <div id="create-playlist-screen">
        <h1>Create a new playlist</h1>
        <input id="CPS-NAME" placeholder="Playlist name" type="text"><br><br>
        <button id="save-playlist-button">Create Playlist</button>
    </div>
    <div id="playlist-modal">
        <h1 id="PM-NAME">PLAYLIST NAME</h1>
    </div>

    <script>
        var noProgressUpdate = false;
        var likeButtonDisabled = true;
        var likes = [];
        var playlists = [];
        function openPlaylistScreen(id) {
            var pl = null;
            for (let i = 0; i < playlists.length; i++) {
                if (playlists[i].id === id) {
                    pl = playlists[i];
                    break;
                }
            }
            if (pl === null) return;
            document.getElementById("PM-NAME").innerText = pl.name;
            document.getElementById("playlist-modal").style.display = "block";
        }
        function refreshPlaylists() {
            var holders = document.createElement("div");

            document.getElementById("playlists").innerHTML = "";

            for (let i = 0; i < playlists.length; i++) {
                const pl = playlists[i];

                var holder = document.createElement("div");
                holder.style.borderRadius = "8px";
                holder.style.background = "rgba(255, 255, 255, 0.04)";
                holder.style.width = "400px";
                holder.style.height = "80px";
                holder.style.cursor = "pointer";
                holder.style.transition = ".15s";
                holder.style.display = "flex";
                holder.style.alignItems = "center";
                holder.style.userSelect = "none";
                holder.className = "playlist-data-holder";
                holder.onclick = () => {
                    openPlaylistScreen(pl.id);
                }
                if (i === 0) {
                    holder.style.marginTop = "0";
                } else {
                    holder.style.marginTop = "10px";
                }

                var image = document.createElement("img");
                image.style.width = "64px";
                image.style.height = "64px";
                image.style.marginLeft = "8px";
                image.style.borderRadius = "6px";
                image.style.marginRight = "20px";
                image.style.border = "none";
                image.src = pl.image === null ? "/cdn/playlist_not_found.png" : pl.image;

                var basicDetailsContainer = document.createElement("div");
                basicDetailsContainer.style.display = "flex"
                basicDetailsContainer.style.justifyContent = "center";
                basicDetailsContainer.style.flexDirection = "column";
                basicDetailsContainer.style.height = "100%";

                var name = document.createElement("span");
                name.innerText = pl.name;
                name.style.fontWeight = "bold";
                name.style.fontSize = "20px";
                name.style.maxWidth = "200px";
                name.style.overflow = "hidden";
                name.style.textOverflow = "ellipsis";
                name.style.whiteSpace = "nowrap";

                var desc = document.createElement("span");
                desc.innerText = pl.description;
                desc.style.fontSize = "15px";
                desc.style.paddingTop = "2.5px";
                desc.style.maxWidth = "280px";
                desc.style.overflow = "hidden";
                desc.style.textOverflow = "ellipsis";
                desc.style.whiteSpace = "nowrap";

                basicDetailsContainer.appendChild(name);
                if (pl.description !== null) basicDetailsContainer.appendChild(desc);

                holder.appendChild(image);
                holder.appendChild(basicDetailsContainer);

                holders.appendChild(holder)
            }

            document.getElementById("playlists").appendChild(holders);
        }
        function loadSavedData() {
            likes = localStorage.getItem("likes") === null ? [] : JSON.parse(localStorage.getItem("likes"));
            playlists = localStorage.getItem("playlists") === null ? [] : JSON.parse(localStorage.getItem("playlists"));
            
            refreshPlaylists();
        }
        function isCurrentSongLiked() {
            const songId = getSongMeta().id;
            var isLiked = false;
            for (let i = 0; i < likes.length; i++) {
                if (likes[i] === songId) {
                    isLiked = true;
                    break;
                }
            }
            return isLiked;
        }
        function toggleLikeCurrentSong() {
            if (likeButtonDisabled) return;
            likeButtonDisabled = true;
            const songId = getSongMeta().id;
            var complete = false;
            for (let i = 0; i < likes.length; i++) {
                if (likes[i] === songId) {
                    likes.splice(i, 1);
                    complete = true;
                    break;
                }
            }
            if (!complete) {
                likes.push(songId);
            }
            localStorage.setItem("likes", JSON.stringify(likes));
            likeButtonDisabled = false;
            refreshSongDataDisplays();
        }
        loadSavedData();
        function createPlaylist(name) {
            var playlistData = {
                name: name,
                description: null,
                image: null,
                createdAt: new Date().getTime(),
                id: Math.round(Math.random() * 9e9)
            }
            playlists.push(playlistData);
            localStorage.setItem("playlists", JSON.stringify(playlists));
            refreshPlaylists();
            document.getElementById("create-playlist-screen").style.display = "none";
        }
        document.getElementById("save-playlist-button").onclick = () => {
            createPlaylist(document.getElementById("CPS-NAME").value);
        }
        document.getElementById("create-playlist-button").onclick = () => {
            document.getElementById("create-playlist-screen").style.display = "block";
        }
        document.getElementById("progress").onclick = (e) => {
            if (!isNaN(document.getElementById("player").duration)) {
                var elmnt = document.getElementById("dragger");
                var track = document.getElementById("progress");
                var handle = document.getElementById("progress-tracker");
                var movement = e.clientX - 50;
                if (movement < 0) {
                    movement = 0;
                } else if (movement > (track.clientWidth - 12)) {
                    movement = track.clientWidth - 12;
                }
                elmnt.style.left = movement + "px";
                handle.style.width = (movement + 6) + "px";
                var newP = (elmnt.style.left.split("px")[0] / (track.clientWidth - 12));
                document.getElementById("player").currentTime = (document.getElementById("player").duration * newP)
            }
        }
        function refreshSongTime() {
            if (!isNaN(document.getElementById("player").duration)) {
                var sec = Math.floor(document.getElementById("player").currentTime);
                var minutes = Math.floor(sec / 60).toString();
                var seconds = (sec - minutes * 60).toString();
                if (minutes.length == 1) {
                    minutes = "0" + minutes
                }
                if (seconds.length == 1) {
                    seconds = "0" + seconds
                }

                var sec1 = Math.floor(document.getElementById("player").duration);
                var minutes1 = Math.floor(sec1 / 60).toString();
                var seconds1 = (sec1 - minutes1 * 60).toString();
                if (minutes1.length == 1) {
                    minutes1 = "0" + minutes1
                }
                if (seconds1.length == 1) {
                    seconds1 = "0" + seconds1
                }

                document.getElementById("song-time").innerText = minutes + ":" + seconds + " / " + minutes1 + ":" + seconds1;
            }
        }
        setInterval(refreshSongTime, 100);
        function refreshSongDataDisplays() {
            var icon = "";
            if (getSongMeta().name !== "" && getSongMeta().name !== "") {
                icon = `<svg style="filter: invert(); margin-right: 10px;" width="22px" height="22px" clip-rule="evenodd" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m12 5.72c-2.624-4.517-10-3.198-10 2.461 0 3.725 4.345 7.727 9.303 12.54.194.189.446.283.697.283s.503-.094.697-.283c4.977-4.831 9.303-8.814 9.303-12.54 0-5.678-7.396-6.944-10-2.461z" fill-rule="nonzero"/></svg>`;
                if (!isCurrentSongLiked()) {
                    icon = `<svg style="filter: invert(); margin-right: 10px;" width="22px" height="22px" clip-rule="evenodd" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m7.234 3.004c-2.652 0-5.234 1.829-5.234 5.177 0 3.725 4.345 7.727 9.303 12.54.194.189.446.283.697.283s.503-.094.697-.283c4.977-4.831 9.303-8.814 9.303-12.54 0-3.353-2.58-5.168-5.229-5.168-1.836 0-3.646.866-4.771 2.554-1.13-1.696-2.935-2.563-4.766-2.563zm0 1.5c1.99.001 3.202 1.353 4.155 2.7.14.198.368.316.611.317.243 0 .471-.117.612-.314.955-1.339 2.19-2.694 4.159-2.694 1.796 0 3.729 1.148 3.729 3.668 0 2.671-2.881 5.673-8.5 11.127-5.454-5.285-8.5-8.389-8.5-11.127 0-1.125.389-2.069 1.124-2.727.673-.604 1.625-.95 2.61-.95z" fill-rule="nonzero"/></svg>`;
                }
            }
            document.getElementById("song-name").innerHTML = `
                <a id="like-song-button" onclick="toggleLikeCurrentSong()">${icon}</a>
                ${getSongMeta().name}
            `
            document.getElementById("album-art").src = "/art/" + getSongMeta().art;
            document.title = getSongMeta().name !== "" && getSongMeta().name !== "" ? getSongMeta().name : "Vinga Music Stream";
            const songNameSections = getSongMeta().name.toString().split(" - ");
            if (songNameSections[0] !== undefined && songNameSections[1] !== undefined) {
                const songArtist = songNameSections[1].includes(" Ft. ") ? songNameSections[0].split(" &").join(",") + ", " + songNameSections[1].split(" Ft. ")[1].split(" &").join(",") : songNameSections[0].split(" &").join(",");
                const songName = songNameSections[1].includes(" Ft. ") ? songNameSections[1].split(" Ft.")[0] : songNameSections[1];
                console.log("Playing", songName, "by", songArtist);
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: songName,
                    artist: songArtist,
                    artwork: [
                        { src: location.protocol+"//"+location.host+"/art/"+getSongMeta().art,   sizes: '300x300',   type: 'image/png' },
                    ]
                });
            }
            refreshSongTime();
        }
        refreshSongDataDisplays();
        function hideAlbumArt() {
            document.getElementById("album-art").style.opacity = 0;
            document.getElementById("album-art").style.top = "-210px";
        }
        function showAlbumArt() {
            document.getElementById("album-art").style.opacity = 1;
            document.getElementById("album-art").style.top = "-220px";
        }
        function dragElement(elmnt, track, handle, setPTime = false) {
            elmnt.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                if (setPTime) {
                    if (isNaN(document.getElementById("player").duration)) {
                        return
                    }
                }
                e = e || window.event;
                e.preventDefault();
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                noProgressUpdate = true;
                elmnt.style.transition = "0s";
                handle.style.transition = "0s";
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                var movement = e.clientX - 50;
                if (movement < 0) {
                    movement = 0;
                } else if (movement > (track.clientWidth - 12)) {
                    movement = track.clientWidth - 12
                }
                elmnt.style.left = movement + "px"
                handle.style.width = (movement + 6) + "px"
            }

            function closeDragElement() {
                try {
                    var newP = (elmnt.style.left.split("px")[0] / (track.clientWidth - 12));

                    if (setPTime) {
                        document.getElementById("player").currentTime = (document.getElementById("player").duration * newP)
                    }
                } catch { }

                document.onmouseup = null;
                document.onmousemove = null;
                noProgressUpdate = false;
                elmnt.style.transition = ".3s";
                handle.style.transition = ".3s";
            }
        }
        dragElement(document.getElementById("dragger"), document.getElementById("progress"), document.getElementById("progress-tracker"), true);
        document.getElementById("player").onplay = () => {
            showAlbumArt();
            refreshSongDataDisplays();
            likeButtonDisabled = false;
            fetch("/random")
            .then(r => r.json())
            .then(r => {
                nextSongData = r;
            });
        }
        document.getElementById("player").ontimeupdate = (d) => {
            var percentPlayed = parseFloat(((document.getElementById("player").currentTime / document.getElementById("player").duration) * 100).toFixed(4));
            if (isNaN(percentPlayed)) {
                percentPlayed = 0.6;
            }
            if (percentPlayed > 0 && percentPlayed < 0.6) {
                percentPlayed = 0.6
            }
            if (!noProgressUpdate) {
                document.getElementById("progress-tracker").style.width = percentPlayed + "%"
                document.getElementById("dragger").style.left = (percentPlayed - 0.6) + "%"
            }
        }
        function getSongMeta() {
            try {
                var d = JSON.parse(document.getElementById("player").getAttribute("song-data"));
                if (d === null) {
                    return {
                        name: ""
                    };
                } else {
                    return d;
                }
            } catch {
                return {
                    name: ""
                };
            }
        }
        function setSongMeta(d) {
            document.getElementById("player").setAttribute("song-data", JSON.stringify(d));
        }
        var nextSongData = null;
        document.getElementById("player").onended = () => {
            hideAlbumArt();
            document.getElementById("s1").src = "/audio/"+nextSongData.id;
            document.getElementById("player").load();
            setSongMeta(nextSongData);
            setTimeout(() => {
                document.getElementById("player").play();
            }, 800);
        }
        const refreshSearch = (chkKey, e) => {
            var v = document.getElementById("search").value;
            if (chkKey && e.key !== "Enter") {
                v = v + e.key;
            }
            fetch("/search/"+encodeURIComponent(v))
            .then(r => {
                if (r.status === 200) {
                    r.json()
                    .then(r => {
                        document.getElementById("results").innerHTML = "";
                        var container = document.createElement("div");
                        r.forEach(el => {
                            var lcon = document.createElement("div");
                            lcon.style.display = "flex";
                            lcon.style.alignItems = "center";
                            lcon.style.padding = "5px";
                            lcon.style.cursor = "pointer";
                            lcon.onclick = () => {
                                try { document.getElementById("player").pause() } catch { }
                                hideAlbumArt();
                                setSongMeta(el);
                                setTimeout(() => {
                                    document.getElementById("s1").src = "/audio/"+el.id;
                                    document.getElementById("player").load();
                                    document.getElementById("player").play();
                                }, 300);
                            }
                            var img = document.createElement("img");
                            img.src = "/art/"+el.art
                            img.style.width = "60px";
                            img.style.height = "60px";
                            img.style.borderRadius = "6px";
                            var name = document.createElement("span");
                            name.innerText = el.name
                            name.style.paddingLeft = "10px";
                            lcon.appendChild(img);
                            lcon.appendChild(name);
                            container.appendChild(lcon);
                        });
                        document.getElementById("results").appendChild(container);
                    })
                } else {
                    document.getElementById("results").innerHTML = "";
                }
            })
        }
        document.getElementById("search").onkeypress = (e) => {
            refreshSearch(true, e)
        };
        document.getElementById("search").onkeydown = (e) => {
            refreshSearch(false, e)
        };
    </script>
</body>
</html>